name: Build Portable Privoxy
on:
  workflow_dispatch:
  push:
    branches:
      - main
jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install dependencies on macOS
        if: matrix.os == 'macos-latest'
        run: brew install autoconf automake pcre
      
      - name: Install dependencies on Linux
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y autoconf automake libpcre3-dev
      
      - name: Download Privoxy source
        run: |
          PRIVOXY_VERSION="3.0.34"
          # 使用正确的 SourceForge 下载链接
          wget "https://sourceforge.net/projects/ijbswa/files/Sources/3.0.34%20%28stable%29/privoxy-3.0.34-stable-src.tar.gz/download" -O privoxy.tar.gz
          tar -xzf privoxy.tar.gz
          # 解压后的目录名是 privoxy-3.0.34-stable，不是 privoxy-3.0.34
          mv privoxy-3.0.34-stable privoxy-src
      
      - name: Configure and compile Privoxy
        run: |
          cd privoxy-src
          autoheader
          autoconf
          ./configure --enable-static
          make
      
      - name: Modify Privoxy configuration
        run: |
          cd privoxy-src
          cp config default.config
          # 修改配置文件，让Privoxy监听所有网络接口
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            sed -i '.bak' 's/^listen-address  127.0.0.1:8118/listen-address  0.0.0.0:8118/' default.config
            sed -i '.bak' 's/^listen-address  \[::1\]:8118/#listen-address  [::1]:8118/' default.config
          else
            sed -i 's/^listen-address  127.0.0.1:8118/listen-address  0.0.0.0:8118/' default.config
            sed -i 's/^listen-address  \[::1\]:8118/#listen-address  [::1]:8118/' default.config
          fi
          echo "验证配置修改："
          grep "listen-address" default.config | head -5
      
      - name: Create packaging directory
        run: |
          mkdir privoxy-package
          cd privoxy-src
          cp privoxy ../privoxy-package/
          cp default.config ../privoxy-package/
          
          # 为Linux创建启动脚本
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            cat > ../privoxy-package/start-privoxy.sh << 'EOF'
          #!/bin/bash
          DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
          echo "Starting Privoxy on 0.0.0.0:8118..."
          echo "Press Ctrl+C to stop"
          "$DIR/privoxy" "$DIR/default.config"
          EOF
            chmod +x ../privoxy-package/start-privoxy.sh
          fi
          
          # 为macOS创建启动脚本
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            cat > ../privoxy-package/start-privoxy.sh << 'EOF'
          #!/bin/bash
          DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
          echo "Starting Privoxy on 0.0.0.0:8118..."
          echo "Press Ctrl+C to stop"
          "$DIR/privoxy" "$DIR/default.config"
          EOF
            chmod +x ../privoxy-package/start-privoxy.sh
          fi
          
          # 创建README文件
          cat > ../privoxy-package/README.txt << 'EOF'
          Privoxy Portable Version
          ========================
          
          Quick Start:
          1. Run: ./start-privoxy.sh
          2. Configure your browser HTTP proxy to: 127.0.0.1:8118
          3. Or use as network proxy server: YOUR_COMPUTER_IP:8118
          
          Files:
          - privoxy: Main executable
          - default.config: Configuration file (listens on 0.0.0.0:8118)
          - start-privoxy.sh: Startup script
          
          Note: This version listens on all network interfaces (0.0.0.0:8118)
          which means other devices on your network can use it as a proxy.
          
          To stop: Press Ctrl+C
          EOF
      
      - name: Package Privoxy for macOS
        if: runner.os == 'macOS'
        run: |
          tar -czf privoxy-portable-macos.tar.gz -C privoxy-package .
      
      - name: Package Privoxy for Linux
        if: runner.os == 'Linux'
        run: |
          tar -czf privoxy-portable-linux.tar.gz -C privoxy-package .
      
      - name: Upload Privoxy artifact
        uses: actions/upload-artifact@v4
        with:
          name: privoxy-portable-${{ runner.os }}
          path: |
            privoxy-portable-*.tar.gz
          if-no-files-found: error
